---
import "../styles/projects.css";
import Layout from "../layouts/Layout.astro";
import Hero from "../components/commons/hero/hero.astro";
import ProjectCard from "../components/project/proyectCard.astro";
import Banner from "../components/commons/banners/banner.astro";
import { proyectos } from "../data/projectData.js";
---

<Layout title="Proyectos" description="Proyectos">
  <Hero titulo="Proyectos" />

  <div class="mt-6 mb-6 flex flex-wrap justify-center gap-3 px-2">
    <button class="filter-btn cursor-pointer rounded-full bg-[#00ffab] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#B900BC] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="all">
      Todos
    </button>
    <button class="filter-btn cursor-pointer rounded-full bg-[#00ffab] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#B900BC] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="End-to-end">
      End-to-end
    </button>
    <button class="filter-btn cursor-pointer rounded-full bg-[#00ffab] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#B900BC] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="EDA & ETL">
      EDA & ETL
    </button>
    <button class="filter-btn cursor-pointer rounded-full bg-[#00ffab] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#B900BC] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="Data Modeling & SQL">
      Data Modeling & SQL
    </button>
    <button class="filter-btn cursor-pointer rounded-full bg-[#00ffab] px-5 py-1.5 text-sm font-bold text-[#1d1250] drop-shadow-[2px_2px_0_#B900BC] transition-all duration-150 active:translate-y-0.5 active:drop-shadow-none" data-filter="Visualization">
      Visualization
    </button>
  </div>

  <div
    id="projects-container"
    class="4xl:px-96 flex flex-wrap justify-center gap-5 px-3 pt-5 xl:px-32 2xl:px-60"
  >
    {
      proyectos.map((proyecto, index) => (
        <ProjectCard
          index={index}
          titulo={proyecto.titulo}
          descripcion={proyecto.descripcion}
          imagen={proyecto.imagen}
          tecnologias={proyecto.tecnologias}
          codigo={proyecto.codigo}
          categoria={proyecto.categoria}
        />
      ))
    }
  </div>

  <div class="flex justify-center mt-12 mb-12">
    <button
      id="load-more"
      class="px-8 py-3 cursor-pointer bg-[#B900BC] text-white font-bold rounded-full hover:bg-[#D400D8] drop-shadow-[3px_3px_0_#00ffab] active:translate-y-0.5 active:drop-shadow-none transition-all"
    >
      Ver más proyectos
    </button>
  </div>

  <Banner />
</Layout>

<script is:inline>
(function () {
  const VISIBLE_CLASS = "project-visible";
  const HIDDEN_CLASS = "project-hidden";
  const HIDE_TIMEOUT = 300;

  const INITIAL_VISIBLE = 6; // Bajado a 6 para que se note el efecto de "Ver más"
  let itemsToShow = INITIAL_VISIBLE;
  let activeFilter = "all";

  function applyFilter(filter) {
    activeFilter = filter || "all";
    const cards = Array.from(document.querySelectorAll(".project-card"));
    
    // IMPORTANTE: Trim para evitar errores por espacios invisibles
    const normalizedFilter = activeFilter.toLowerCase().trim();

    const filteredCards = cards.filter((card) => {
      const categoria = (card.getAttribute("data-categoria") || "").toLowerCase().trim();
      return normalizedFilter === "all" || categoria === normalizedFilter;
    });

    cards.forEach((c) => {
        c.classList.remove(VISIBLE_CLASS);
        c.classList.add(HIDDEN_CLASS);
        setTimeout(() => {
            if (c.classList.contains(HIDDEN_CLASS)) c.style.display = "none";
        }, HIDE_TIMEOUT);
    });

    filteredCards.forEach((card, i) => {
      if (i < itemsToShow) {
        setTimeout(() => {
            card.style.display = "flex";
            requestAnimationFrame(() => {
                card.classList.remove(HIDDEN_CLASS);
                card.classList.add(VISIBLE_CLASS);
            });
        }, HIDE_TIMEOUT);
      }
    });

    const loadMoreBtn = document.getElementById("load-more");
    if (loadMoreBtn) {
      loadMoreBtn.style.display = filteredCards.length > itemsToShow ? "block" : "none";
    }
  }

  function init() {
    const filterButtons = document.querySelectorAll(".filter-btn");
    const loadMoreBtn = document.getElementById("load-more");

    filterButtons.forEach((btn) => {
      btn.onclick = () => {
        itemsToShow = INITIAL_VISIBLE;
        filterButtons.forEach(b => b.style.opacity = "0.7");
        btn.style.opacity = "1";
        applyFilter(btn.dataset.filter);
      };
    });

    if (loadMoreBtn) {
      loadMoreBtn.onclick = () => {
        itemsToShow += INITIAL_VISIBLE;
        applyFilter(activeFilter);
      };
    }

    applyFilter("all");
  }

  document.addEventListener("astro:page-load", init);
  window.addEventListener("load", init);
})();
</script>
